<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Report Logs</title>
  <link rel="stylesheet" href="user-help-log.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
  
</head>
<body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="logo" />
        <span class="logo-text">UIP <br>Tracker</span>
      </div>
      <ul class="sidebar-links">
        <li><a href="user-dashboard.html"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Attendance</a></li>
        <li><a href="#"><span class="material-symbols-outlined">account_circle</span>Online Users</a></li>
        <li><a href="#"><span class="material-symbols-outlined">notifications_active</span>Event</a></li>
        <li><a href="user-help.html" class="active"><span class="material-symbols-outlined">flag</span>Help</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Developers</a></li>
      </ul>
    </aside>

    <main class="main-content">
        <div class="header">
           <div class="header-title" style="display: flex; align-items: center; gap: 10px;">
              <span class="material-symbols-outlined" style="font-size: 40px; color: #021D44;">history</span>
              <h1 style="color: #021D44;">MY REPORT LOGS</h1>
            </div>
            <button class="user-profile" id="profileBtn">
              <div class="user-avatar" id="userAvatar">U</div>
              <div class="user-details">
                <h3 id="userName">User</h3><p id="userRole">Role</p>
              </div>
              <span class="material-symbols-outlined" style="color: #9197B3;">expand_more</span>
              <div class="dropdown-menu" id="userDropdown">
            <a href="#" class="dropdown-item">
              <span class="material-symbols-outlined">person</span>
              Profile
            </a>
            <a href="#" class="dropdown-item">
              <span class="material-symbols-outlined">settings</span>
              Change Password
            </a>
          <div class="dropdown-divider" style="margin: 0 16px;"></div>
            <a href="signin.html" class="dropdown-item">
              <span class="material-symbols-outlined">logout</span>
              Sign out
            </a>
          </div>
        </button>
      </div>

        <div class="logs-container">
            <div class="logs-header">
                <h2>MY SUBMITTED ISSUES</h2>
                <a href="user-help.html" class="submit-new-btn">Submit new report</a>
            </div>
            <table class="issues-table">
                <thead>
                    <tr>
                        <th>TICKET ID</th>
                        <th>SUBJECT</th>
                        <th>STATUS</th>
                        <th>ADMIN REPLY</th>
                    </tr>
                </thead>
                <tbody id="issuesTableBody"></tbody>
            </table>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

    // --- Page Protection & Personalization ---
    if (!loggedInUser) {
        alert('You must be logged in to view this page.');
        window.location.href = 'signin.html';
        return;
    }
    document.getElementById('userName').textContent = loggedInUser.full_name;
    document.getElementById('userRole').textContent = loggedInUser.role;
    const nameParts = loggedInUser.full_name.split(' ');
    document.getElementById('userAvatar').textContent = (nameParts.length > 1 ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : nameParts[0][0]).toUpperCase();

    // --- Logic to Fetch and Display User-Specific Reports ---
    async function loadMyReports() {
        const tableBody = document.getElementById('issuesTableBody');
        try {
            const response = await fetch('api_get_reports.php');
            if (!response.ok) throw new Error('Failed to fetch reports.');
            const result = await response.json();
            
            // --- Filter reports to show only the current user's ---
            const myReports = result.data.filter(report => report.user_id == loggedInUser.id);

            tableBody.innerHTML = ''; // Clear existing content

            if (myReports.length > 0) {
                myReports.forEach(report => {
                    const row = document.createElement('tr');
                     row.innerHTML = `
                        <td>${report.ticket_id}</td>
                        <td>${report.subject}</td>
                        <td>${report.status}</td>
                        <td>${report.admin_reply || 'No reply yet.'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `<tr class="no-data"><td colspan="4">You have not submitted any reports.</td></tr>`;
            }
        } catch (error) {
            console.error('Error fetching reports:', error);
            tableBody.innerHTML = `<tr class="no-data"><td colspan="4">Error loading data.</td></tr>`;
        }
    }
    
    loadMyReports(); // Load the reports when the page is ready

    // --- Dropdown Logic ---
    const profileBtn = document.getElementById("profileBtn");
    const userDropdown = document.getElementById("userDropdown");
    if(profileBtn) {
      profileBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle("show");
      });
    }
    document.addEventListener("click", () => userDropdown.classList.remove("show"));
});
</script>
</body>
</html>