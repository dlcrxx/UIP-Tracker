<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>USER HELP</title>
    <link rel="stylesheet" href="user-help.css">
  <!-- Quill Rich Text Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>

</head>
<body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="logo" />
        <span class="logo-text">UIP <br>Tracker</span>
      </div>
      <ul class="sidebar-links">
        <li><a href="user-dashboard.html"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Attendance</a></li>
        <li><a href="#"><span class="material-symbols-outlined">account_circle</span>Online Users</a></li>
        <li><a href="#"><span class="material-symbols-outlined">notifications_active</span>Event</a></li>
        <li><a href="user-help.html"><span class="material-symbols-outlined">flag</span>Help</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Developers</a></li>
      </ul>
    </aside>

    <main class="main-content">
        <div class="header">
           <div class="header-title" style="display: flex; align-items: center; gap: 10px;">
              <span class="material-symbols-outlined" style="font-size: 40px; color: #021D44;">flag</span>
              <h1 style="color: #021D44;">SUBMIT SYSTEM ISSUE</h1>
            </div>
             <button class="user-profile" id="profileBtn">
              <div class="user-avatar" id="userAvatar">U</div>
              <div class="user-details">
                <h3 id="userName">User</h3>
                <p id="userRole">Role</p>
              </div>
              <span class="material-symbols-outlined" style="color: #9197B3;">expand_more</span>
              <div class="dropdown-menu" id="userDropdown">
                <a href="manage-profile.html" class="dropdown-item"><span class="material-symbols-outlined">person</span>Profile</a>
                <a href="#" class="dropdown-item"><span class="material-symbols-outlined">settings</span>Change Password</a>
                <div class="dropdown-divider"></div>
                <a href="signin.html" id="logoutBtn" class="dropdown-item"><span class="material-symbols-outlined">logout</span>Sign out</a>
              </div>
            </button>
        </div>

        <div class="report-section">
            <h2 class="form-title">SUBMIT SYSTEM ISSUE/BUG ENCOUNTER ONLY</h2>
            <form id="reportForm">
                <div class="form-group">
                    <label for="ticket-id">TICKET ID</label>
                    <div class="ticket-id-group">
                        <input type="text" id="ticket-id" name="ticket-id" value="" readonly>
                        <a href="user-help-log.html" class="logs-btn">LOGS</a>
                    </div>
                </div>
                <div class="form-group">
                    <label for="subject">SUBJECT</label>
                    <input type="text" id="subject" name="subject" placeholder="Enter Subject" required>
                </div>
                <div class="form-group">
                    <label>DETAILS</label>
                    <div id="editor"><p>Enter Details</p></div>
                </div>
                <div class="form-group">
                    <label for="files">FILES</label>
                    <input type="text" id="files" name="files" placeholder="Enter Google Drive">
                </div>
                <button type="submit" class="send-btn">SEND</button>
            </form>
        </div>
    </main>

<!-- Quill Rich Text Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- SINGLE, CONSOLIDATED SCRIPT FOR ALL PAGE FUNCTIONALITY -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. Get User and Protect Page ---
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) {
        alert('You must be logged in to access this page.');
        window.location.href = 'signin.html';
        return;
    }

    // --- 2. Personalize UI Elements ---
    document.getElementById('userName').textContent = loggedInUser.full_name;
    document.getElementById('userRole').textContent = loggedInUser.role;
    const nameParts = loggedInUser.full_name.split(' ');
    const initials = (nameParts.length > 1) ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : nameParts[0][0];
    document.getElementById('userAvatar').textContent = initials.toUpperCase();

    // --- 3. Generate Ticket ID ---
    function generateTicketId() {
        const year = new Date().getFullYear();
        const randomChars = Math.random().toString(36).substring(2, 12).toUpperCase();
        return `${year}-${randomChars}`;
    }
    document.getElementById('ticket-id').value = generateTicketId();

    // --- 4. Handle Form Submission ---
    const reportForm = document.getElementById('reportForm');
    if (reportForm) {
         var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{'list': 'ordered'}, {'list': 'bullet'}],
                    ['link', 'image'] // Make sure 'image' is included
                ]
            }
        });

        reportForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const reportData = {
                ticketId: document.getElementById('ticket-id').value,
                subject: document.getElementById('subject').value,
                details: quill.root.innerHTML,
                files: document.getElementById('files').value,
                userId: loggedInUser.id,
                userName: loggedInUser.full_name
            };

            try {
                // KEY CHANGE: Submit to the new PHP script
                const response = await fetch('api_add_report.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reportData)
                });
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Failed to submit report.');
                }
                alert('Report submitted successfully!');
                window.location.href = 'user-help-log.html'; // Redirect to the user's log page
            } catch (error) {
                console.error('Error submitting report:', error);
                alert(`Failed to submit report. Error: ${error.message}`);
            }
        });
    }
        // --- Logic for Profile Dropdown Menu ---
        const profileBtn = document.getElementById("profileBtn");
        const userDropdown = document.getElementById("userDropdown");
        if (profileBtn && userDropdown) {
            profileBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle("show");
            });
        }

        // --- Logic to Close Dropdown on Outside Click ---
        document.addEventListener("click", (event) => {
            if (userDropdown && profileBtn && !profileBtn.contains(event.target)) {
                userDropdown.classList.remove("show");
            }
        });

        // --- Logic for Sidebar Link Clicks ---
        document.querySelectorAll('.sidebar-links a').forEach(link => {
            link.addEventListener('click', function(e) {
                document.querySelectorAll('.sidebar-links a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });
</script>
</body>
</html>