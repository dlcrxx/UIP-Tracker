<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Navbar & Dropdown</title>
  <!-- Quill Rich Text Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #F0F4FF; display: flex; min-height: 100vh; }
    .sidebar { position: sticky; top: 0; left: 0; height: 100%; min-height: 1000px; width: 80px; display: flex; overflow-x: hidden; flex-direction: column; background: #ffffff; padding: 25px 20px; transition: all 0.4s ease; }
    .sidebar:hover { width: 260px; }
    .sidebar .sidebar-header { display: flex; align-items: center; }
    .sidebar .sidebar-header img { width: 50px; border-radius: 50%; padding: 0; }
    .sidebar .sidebar-header span { color: #021D44; font-size: 1.25rem; font-weight: 600; white-space: nowrap; margin-left: 10px; }
    .sidebar-links { list-style: none; margin-top: 20px; height: 80%; overflow-y: auto; scrollbar-width: none; }
    .sidebar-links::-webkit-scrollbar { display: none; }
    .sidebar-links li a { display: flex; align-items: center; gap: 0 20px; color: #9197B3; font-weight: 500; font-size: 0.9rem; white-space: nowrap; padding: 12px 10px; text-decoration: none; transition: 0.2s ease; border-radius: 6px; }
    .sidebar-links li a:hover { color: #ffffff; background: #021D44; border-radius: 10px; }
    .main-content { flex: 1; padding: 30px; display: flex; flex-direction: column; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0; background: transparent; }
    .header h1 { color: #021D44; font-size: 1.8rem; font-weight: 600; margin-bottom: 0; }
    .user-profile { display: flex; align-items: center; gap: 12px; background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s ease; position: relative; justify-content: flex-end; }
    .user-profile:hover { background-color: rgba(255, 255, 255, 0.1); }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #021D44; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
    .user-details h3 { color: #021D44; font-size: 0.9rem; font-weight: 600; margin: 0; justify-content: flex-end; }
    .user-details p { color: #9197B3; font-size: 0.8rem; margin: 0; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); padding: 8px 0; min-width: 180px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000; }
    .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #021D44; text-decoration: none; transition: background-color 0.2s ease; font-size: 0.9rem; }
    .dropdown-item:hover { background-color: #f8f9ff; }
    .dropdown-divider { height: 1px; background-color: #e0e0e0; margin: 4px 0; }
    .report-section { background: white; padding: 30px; border-radius: 15px; width: 100%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); margin: 0 auto; }
    .report-section .form-title { color: #021D44; font-size: 1.1rem; font-weight: 700; margin-bottom: 30px; text-align: center; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; color: #021D44; font-weight: 600; font-size: 0.85rem; margin-bottom: 8px; }
    .ticket-id-group { display: flex; align-items: center; gap: 10px; }
    .form-group input[type="text"] { width: 100%; padding: 12px 15px; border: 1px solid #E0E0E0; border-radius: 8px; background-color: #F8F9FF; color: #021D44; font-size: 0.9rem; }
    .ticket-id-group input { background-color: #F0F4FF; border: 1px solid #E0E0E0; flex-grow: 1; }
    .logs-btn { padding: 12px 20px; background-color: #021D44; color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-decoration: none; }
    .ql-toolbar { border-top-left-radius: 8px; border-top-right-radius: 8px; border: 1px solid #E0E0E0 !important; background: #F8F9FF; }
    .ql-container { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border: 1px solid #E0E0E0 !important; min-height: 150px; font-size: 0.9rem; background: #F8F9FF; }
    .send-btn { display: inline-block; padding: 12px 40px; background-color: #021D44; color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; margin-top: 10px; }
    .send-btn:hover { background-color: #003366; }
    @media (max-width: 768px) { .main-content { margin-left: 0; padding: 20px; } .sidebar { transform: translateX(-100%); } .sidebar:hover { transform: translateX(0); } }
  </style>
</head>
<body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="logo" />
        <span class="logo-text">UIP <br>Tracker</span>
      </div>
      <ul class="sidebar-links">
        <li><a href="user-dashboard.html"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Attendance</a></li>
        <li><a href="#"><span class="material-symbols-outlined">account_circle</span>Online Users</a></li>
        <li><a href="#"><span class="material-symbols-outlined">notifications_active</span>Event</a></li>
        <li><a href="help.html"><span class="material-symbols-outlined">flag</span>Help</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Developers</a></li>
      </ul>
    </aside>

    <main class="main-content">
        <div class="header">
           <div class="header-title" style="display: flex; align-items: center; gap: 10px;">
              <span class="material-symbols-outlined" style="font-size: 40px; color: #021D44;">flag</span>
              <h1 style="color: #021D44;">SUBMIT SYSTEM ISSUE</h1>
            </div>
            <button class="user-profile" id="profileBtn">
              <div class="user-avatar">DC</div>
              <div class="user-details">
                <h3>Dani Dela Cruz</h3>
                <p>Intern</p>
              </div>
              <span class="material-symbols-outlined" style="color: #9197B3;">expand_more</span>
              <div class="dropdown-menu" id="userDropdown">
                <a href="#" class="dropdown-item"><span class="material-symbols-outlined">person</span>Profile</a>
                <a href="#" class="dropdown-item"><span class="material-symbols-outlined">settings</span>Change Password</a>
                <div class="dropdown-divider"></div>
                <a href="login.html" class="dropdown-item"><span class="material-symbols-outlined">logout</span>Sign out</a>
              </div>
            </button>
        </div>

        <div class="report-section">
            <h2 class="form-title">SUBMIT SYSTEM ISSUE/BUG ENCOUNTER ONLY</h2>
            <form id="reportForm">
                <div class="form-group">
                    <label for="ticket-id">TICKET ID</label>
                    <div class="ticket-id-group">
                        <input type="text" id="ticket-id" name="ticket-id" value="" readonly>
                        <a href="help1.html" class="logs-btn">LOGS</a>
                    </div>
                </div>
                <div class="form-group">
                    <label for="subject">SUBJECT</label>
                    <input type="text" id="subject" name="subject" placeholder="Enter Subject" required>
                </div>
                <div class="form-group">
                    <label>DETAILS</label>
                    <div id="editor"><p>Enter Details</p></div>
                </div>
                <div class="form-group">
                    <label for="files">FILES</label>
                    <input type="text" id="files" name="files" placeholder="Enter Google Drive">
                </div>
                <button type="submit" class="send-btn">SEND</button>
            </form>
        </div>
    </main>

<!-- Quill Rich Text Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- SINGLE, CONSOLIDATED SCRIPT FOR ALL PAGE FUNCTIONALITY -->
<script>
    function generateTicketId() {
        const year = new Date().getFullYear();
        const randomChars = Math.random().toString(36).substring(2, 12).toUpperCase();
        return `${year}-${randomChars}`;
    }

    // Wait for the HTML document to be fully loaded before running any scripts
     document.addEventListener('DOMContentLoaded', () => {
        const ticketIdInput = document.getElementById('ticket-id');
        if (ticketIdInput) {
            ticketIdInput.value = generateTicketId();
        }

        // --- Logic for Report Form Submission ---
         const reportForm = document.getElementById('reportForm');
        if (reportForm) {
            var quill = new Quill('#editor', {
                theme: 'snow',
                modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{'list': 'ordered'}, {'list': 'bullet'}], ['link', 'image']] }
            });

            reportForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                 const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

                // 2. Check if the user is actually logged in.
                if (!loggedInUser || !loggedInUser.id || !loggedInUser.full_name) {
                    alert('Authentication error: Could not find user information. Please log in again.');
                    return; // Stop the submission
                }

                // 3. Create the data object, now including the user's info.
                const reportData = {
                    ticketId: document.getElementById('ticket-id').value,
                    subject: document.getElementById('subject').value,
                    details: quill.root.innerHTML,
                    files: document.getElementById('files').value,
                    // Add the user's details to be sent to the server
                    userId: loggedInUser.id,
                    userName: loggedInUser.full_name
                };
                // --- END OF CORRECTION ---

                try {
                    const response = await fetch('http://localhost:3000/api/reports', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reportData)
                    });
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.message || `HTTP error! Status: ${response.status}`);
                    }
                    alert('Report submitted successfully!');
                    window.location.href = 'help1.html';
                } catch (error) {
                    console.error('Error submitting report:', error);
                    alert(`Failed to submit report. Error: ${error.message}`);
                }
            });
        }

        // --- Logic for Profile Dropdown Menu ---
        const profileBtn = document.getElementById("profileBtn");
        const userDropdown = document.getElementById("userDropdown");
        if (profileBtn && userDropdown) {
            profileBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle("show");
            });
        }

        // --- Logic to Close Dropdown on Outside Click ---
        document.addEventListener("click", (event) => {
            if (userDropdown && profileBtn && !profileBtn.contains(event.target)) {
                userDropdown.classList.remove("show");
            }
        });

        // --- Logic for Sidebar Link Clicks ---
        document.querySelectorAll('.sidebar-links a').forEach(link => {
            link.addEventListener('click', function(e) {
                document.querySelectorAll('.sidebar-links a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });
</script>
</body>
</html>