<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Calendar</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link rel="stylesheet" href="user-event.css">
</head>
<body>
   <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="logo" />
        <span class="logo-text">UIP <br>Tracker</span>
      </div>

      <ul class="sidebar-links">
        <li><a href="dashboard.html"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
        <li><a href="attendance.html" class="active"><span class="material-symbols-outlined">calendar_month</span>Attendance<span class="chevron">&gt;</span></a></li>
        <li><a href="onlineusers.html"><span class="material-symbols-outlined">account_circle</span>Online Users<span class="chevron">&gt;</span></a></li>
        <li><a href="event.html"><span class="material-symbols-outlined">notifications_active</span>Event<span class="chevron">&gt;</span></a></li>
        <li><a href="help.html"><span class="material-symbols-outlined">help</span>Help<span class="chevron">&gt;</span></a></li>
        <li><a href="developers.html"><span class="material-symbols-outlined">deployed_code</span>Developers<span class="chevron">&gt;</span></a></li>
      </ul>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1>Event</h1>
            <button class="user-profile" id="profileBtn" onclick="toggleDropdown()">
           <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <h3 id="userName">User Name</h3>
            <p id="userRole">Role</p>
          </div>
          <span class="material-symbols-outlined" style="color: #9197B3;">expand_more</span>
          <div class="dropdown-menu" id="userDropdown">
            <a href="#" class="dropdown-item"><span class="material-symbols-outlined">person</span>Profile</a>
            <a href="#" class="dropdown-item"><span class="material-symbols-outlined">settings</span>Change Password</a>
            <div class="dropdown-divider" style="margin: 0 16px;"></div>
            <a href="signin.html" id="logoutBtn" class="dropdown-item"><span class="material-symbols-outlined">logout</span>Sign out</a>
          </div>
        </button>
      </div>

        <!-- NEW, SIMPLIFIED HTML LAYOUT -->
        <div class="page-layout">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prevMonthBtn">&lt;</button>
                    <h2 id="currentMonthYear">Month Year</h2>
                    <button id="nextMonthBtn">&gt;</button>
                </div>
                <div class="calendar-grid">
                    <div class="grid-cell day-name">Sun</div>
                    <div class="grid-cell day-name">Mon</div>
                    <div class="grid-cell day-name">Tue</div>
                    <div class="grid-cell day-name">Wed</div>
                    <div class="grid-cell day-name">Thu</div>
                    <div class="grid-cell day-name">Fri</div>
                    <div class="grid-cell day-name">Sat</div>
                </div>
                <div class="calendar-grid" id="calendarDates"></div>
            </div>

            <div class="event-display" id="eventDisplay">
                <h2>Events for Today</h2>
                <p>Select a date to see events.</p>
            </div>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
     const profileBtn = document.getElementById('profileBtn');
        const userDropdown = document.getElementById('userDropdown');
        if (profileBtn && userDropdown) {
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('show');
            });
        }
        document.addEventListener('click', (event) => {
            if (userDropdown && profileBtn && !profileBtn.contains(event.target)) {
                userDropdown.classList.remove('show');
            }
        });
        
        // --- Logic for Logout Button ---
        const logoutBtn = document.getElementById('logoutBtn');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Clear user data from storage
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('token');
                // Redirect to login page
                window.location.href = '/uip-tracker/signin.html';
            });
        }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const userProfile = document.querySelector('.user-profile');
        const dropdown = document.getElementById('userDropdown');
        
        if (!userProfile.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      });
    // --- Page Protection & Personalization ---
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) {
        alert('You are not logged in.');
        window.location.href = 'login.html';
        return;
    }
    document.getElementById('userName').textContent = loggedInUser.full_name;
    document.getElementById('userRole').textContent = loggedInUser.role;
    const nameParts = loggedInUser.full_name.split(' ');
    const initials = (nameParts.length > 1) ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : nameParts[0][0];
    document.getElementById('userAvatar').textContent = initials.toUpperCase();

    // --- Calendar Logic (Rewritten for new design) ---
    const currentMonthYearElem = document.getElementById('currentMonthYear');
    const calendarDatesElem = document.getElementById('calendarDates');
    const eventDisplayElem = document.getElementById('eventDisplay');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    
    let currentDate = new Date();
    let events = [];

    // Fetches announcements from the database and maps them to events
    async function fetchEvents() {
        try {
            const response = await fetch('api_get_announcements.php');
            if (!response.ok) throw new Error('Failed to fetch events.');
            const data = await response.json();
            events = data.map(ann => ({
                date: ann.event_date,
                title: ann.title,
                description: ann.content,
                posted_by: ann.posted_by
            }));
            renderCalendar();
        } catch (error) {
            console.error("Error fetching events:", error);
        }
    }

    // Displays the events for a specific day on the right-hand panel
    function displayEventsForDate(dateStr) {
        const selectedDate = new Date(dateStr + 'T00:00:00'); // Ensure correct date parsing
        const dayEvents = events.filter(e => e.date === dateStr);
        
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        eventDisplayElem.innerHTML = `<h2>Events for ${selectedDate.toLocaleDateString(undefined, options)}</h2>`;
        
        if (dayEvents.length > 0) {
            dayEvents.forEach(event => {
                eventDisplayElem.innerHTML += `
                    <div class="event-item">
                        <h3>${event.title}</h3>
                        <p>${event.description.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            });
        } else {
            eventDisplayElem.innerHTML += '<p>No events scheduled for this day.</p>';
        }
    }

    // Renders the main calendar grid
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        currentMonthYearElem.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        calendarDatesElem.innerHTML = '';
        
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarDatesElem.innerHTML += `<div class="grid-cell"></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            let cellClasses = "grid-cell date-cell";

            if (events.some(e => e.date === dateStr)) {
                cellClasses += " has-event";
            }
            
            const dateCell = document.createElement('div');
            dateCell.className = cellClasses;
            dateCell.textContent = day;
            dateCell.dataset.date = dateStr;
            
            dateCell.addEventListener('click', (e) => {
                // Remove 'selected' from any other date
                document.querySelectorAll('.date-cell.selected').forEach(el => el.classList.remove('selected'));
                // Add 'selected' to the clicked date
                e.currentTarget.classList.add('selected');
                displayEventsForDate(e.currentTarget.dataset.date);
            });
            
            calendarDatesElem.appendChild(dateCell);
        }
    }

    // --- Event Listeners for Calendar Navigation ---
    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // --- Initial Load ---
    fetchEvents();
});
</script>
</body>
</html>