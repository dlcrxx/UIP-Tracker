<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Event Calendar</title>
  <link rel="stylesheet" href="user-event.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
  <style>
  </style>
</head>
<body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="logo" />
         <span class="logo-text">UIP Tracker</span>
      </div>
    <ul class="sidebar-links">
        <li><a href="user-dashboard.html"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
        <li><a href="user-attendance.html" class="active"><span class="material-symbols-outlined">calendar_month</span>Attendance<span class="chevron">&gt;</span></a></li>
        <li><a href="user-onlineuser.html"><span class="material-symbols-outlined">account_circle</span>Online Users<span class="chevron">&gt;</span></a></li>
        <li><a href="user-event.html"><span class="material-symbols-outlined">notifications_active</span>Event<span class="chevron">&gt;</span></a></li>
        <li><a href="user-help.html"><span class="material-symbols-outlined">help</span>Help<span class="chevron">&gt;</span></a></li>
        <li><a href="user-developers.html"><span class="material-symbols-outlined">deployed_code</span>Developers<span class="chevron">&gt;</span></a></li>
      </ul>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1><span class="material-symbols-outlined">event</span> Event</h1>
            <div class="user-profile" id="profileBtn">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details"><h3 id="userName">User</h3><p id="userRole">Role</p></div>
                 <span class="material-symbols-outlined" style="color: #9197B3;">expand_more</span>
          <div class="dropdown-menu" id="userDropdown">
            <a href="#" class="dropdown-item"><span class="material-symbols-outlined">person</span>Profile</a>
            <a href="#" class="dropdown-item"><span class="material-symbols-outlined">settings</span>Change Password</a>
            <div class="dropdown-divider" style="margin: 0 16px;"></div>
            <a href="signin.html" id="logoutBtn" class="dropdown-item"><span class="material-symbols-outlined">logout</span>Sign out</a>
          </div>
        </button>
      </div>
        </header>

        <!-- YOUR ORIGINAL HTML STRUCTURE, RESTORED -->
        <div class="calendar-wrapper">
            <section class="calendar">
                <div class="calendar-header">
                    <button id="prevMonthBtn" class="arrow-btn"><i class="fas fa-chevron-left"></i></button>
                    <div class="calendar-title">
                        <div class="dropdown-picker">
                            <button id="month-button" class="picker-btn">Month</button>
                            <div id="month-dropdown" class="picker"><div class="picker-grid"></div></div>
                        </div>
                        <div class="dropdown-picker">
                            <button id="year-button" class="picker-btn">Year</button>
                            <div id="year-dropdown" class="picker"><div class="picker-grid"></div></div>
                        </div>
                    </div>
                    <button id="nextMonthBtn" class="arrow-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days" id="calendar-days"></div>
            </section>
            <div id="event-display" class="event-display">
                <h2>No Upcoming Activities</h2>
                <p>No activities have been scheduled yet.</p>
            </div>
        </div>
    </main>

<script>
// Use ONE single, consolidated script for all page functionality
document.addEventListener('DOMContentLoaded', () => {
    // --- Page Protection & Personalization ---
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) {
        alert('You are not logged in.');
        window.location.href = 'login.html';
        return;
    }
    document.getElementById('userName').textContent = loggedInUser.full_name;
    document.getElementById('userRole').textContent = loggedInUser.role;
    const nameParts = loggedInUser.full_name.split(' ');
    const initials = (nameParts.length > 1) ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : nameParts[0][0];
    document.getElementById('userAvatar').textContent = initials.toUpperCase();
    
    // --- UI Logic (Dropdowns, Logout) ---
    const profileBtn = document.getElementById('profileBtn');
    const userDropdown = document.getElementById('userDropdown');
    if (profileBtn) profileBtn.addEventListener('click', (e) => { e.stopPropagation(); userDropdown.classList.toggle('show'); });
    document.addEventListener('click', () => { userDropdown?.classList.remove('show'); });
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'login.html';
    });

    // --- Calendar Logic (Adapted for your design) ---
    const calendarDays = document.getElementById("calendar-days");
    const eventDisplay = document.getElementById("event-display");
    const monthButton = document.getElementById("month-button");
    const yearButton = document.getElementById("year-button");
    const monthDropdown = document.getElementById("month-dropdown");
    const yearDropdown = document.getElementById("year-dropdown");
    
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    let events = [];
    let currentDate = new Date();

    async function fetchEvents() {
        try {
            const response = await fetch('api_get_announcements.php');
            const data = await response.json();
            events = data.map(ann => ({ date: ann.event_date, title: ann.title, description: ann.content }));
            renderCalendar();
        } catch (error) { console.error("Error fetching events:", error); }
    }

    function displayEventsForDate(dateStr) {
        const selectedDate = new Date(dateStr + 'T00:00:00');
        const dayEvents = events.filter(e => e.date === dateStr);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        eventDisplay.innerHTML = `<h2>Events for ${selectedDate.toLocaleDateString(undefined, options)}</h2>`;
        if (dayEvents.length > 0) {
            dayEvents.forEach(event => {
                eventDisplay.innerHTML += `<div class="event-item"><h3>${event.title}</h3><p>${event.description}</p></div>`;
            });
        } else {
            eventDisplay.innerHTML += '<p>No events scheduled for this day.</p>';
        }
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthButton.textContent = months[month];
        yearButton.textContent = year;
        calendarDays.innerHTML = "";
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            calendarDays.innerHTML += `<div class="day other-month"></div>`;
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayDiv = document.createElement("div");
            dayDiv.textContent = d;
            dayDiv.className = "day";
            
            if (events.some(e => e.date === dateStr)) {
                dayDiv.classList.add("has-event");
            }
            dayDiv.addEventListener("click", () => {
                document.querySelectorAll(".day.selected").forEach(el => el.classList.remove("selected"));
                dayDiv.classList.add("selected");
                displayEventsForDate(dateStr);
            });
            calendarDays.appendChild(dayDiv);
        }
    }

    // --- Calendar Navigation Listeners ---
    document.getElementById("prevMonthBtn")?.addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    document.getElementById("nextMonthBtn")?.addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

    monthButton.addEventListener("click", (e) => { e.stopPropagation(); monthDropdown.classList.toggle("show"); yearDropdown.classList.remove("show"); });
    yearButton.addEventListener("click", (e) => { e.stopPropagation(); yearDropdown.classList.toggle("show"); monthDropdown.classList.remove("show"); });

    // Populate month dropdown
    monthDropdown.querySelector(".picker-grid").innerHTML = months.map((m, i) => `<button data-month="${i}">${m.substring(0,3)}</button>`).join('');
    monthDropdown.addEventListener('click', (e) => {
        if (e.target.dataset.month) {
            currentDate.setMonth(parseInt(e.target.dataset.month));
            renderCalendar();
            monthDropdown.classList.remove("show");
        }
    });

    // Populate year dropdown
    const currentYear = new Date().getFullYear();
    let yearHTML = '';
    for (let y = currentYear - 5; y <= currentYear + 5; y++) { yearHTML += `<button>${y}</button>`; }
    yearDropdown.querySelector(".picker-grid").innerHTML = yearHTML;
    yearDropdown.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentDate.setFullYear(parseInt(e.target.textContent));
            renderCalendar();
            yearDropdown.classList.remove("show");
        }
    });

    // --- Initial Load ---
    fetchEvents();
});
</script>
</body>
</html>