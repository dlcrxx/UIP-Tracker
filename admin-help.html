<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - Report Management</title>
  <style>
     * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  background-color: #F0F4FF;
  display: flex;
  min-height: 100vh;
}
.sidebar {
  position: sticky;
  top: 0;
  left: 0;
  height: 100%;
  min-height: 1000px;
  width: 80px;
  display: flex;
  overflow-x: hidden;
  flex-direction: column;
  background: #ffffff;
  padding: 25px 20px;
  transition: all 0.4s ease;
}

.sidebar:hover {
  width: 260px;
}

.sidebar .sidebar-header {
  display: flex;
  align-items: center;
}

.sidebar .sidebar-header img {
  width: 50px;
  border-radius: 50%;
  padding: 0;
}

.sidebar .sidebar-header span {
  color: #021D44;
  font-size: 1.25rem;
  font-weight: 600;
  white-space: nowrap;
  margin-left: 10px;
}

.sidebar-links {
  list-style: none;
  margin-top: 20px;
  height: 80%;
  overflow-y: auto;
  scrollbar-width: none;
}

.sidebar-links::-webkit-scrollbar {
  display: none;
}

.sidebar-links li a {
  display: flex;
  align-items: center;
  gap: 0 20px;
  color: #9197B3;
  font-weight: 500;
  font-size: 0.9rem;
  white-space: nowrap;
  padding: 12px 10px;
  text-decoration: none;
  transition: 0.2s ease;
  border-radius: 6px;
}

.sidebar-links li a:hover {
  color: #ffffff;
  background: #021D44;
  border-radius: 10px;
}

.main-content {
  flex: 1;
  padding: 30px;
  display: flex;
  flex-direction: column;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 0;
  background: transparent;
}

.header h1 {
  color: #021D44;
  font-size: 1.8rem;
  font-weight: 600;
  margin-bottom: 0;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: background-color 0.2s ease;
  position: relative;
  justify-content: flex-end;
}

.user-profile:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #021D44;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  
}

.user-details h3 {
  color: #021D44;
  font-size: 0.9rem;
  font-weight: 600;
  margin: 0;
  justify-content: flex-end;
}

.user-details p {
  color: #9197B3;
  font-size: 0.8rem;
  margin: 0;
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  padding: 8px 0;
  min-width: 180px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  z-index: 1000;
}

.dropdown-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  color: #021D44;
  text-decoration: none;
  transition: background-color 0.2s ease;
  font-size: 0.9rem;
}

.dropdown-item:hover {
  background-color: #f8f9ff;
}

.dropdown-divider {
  height: 1px;
  background-color: #e0e0e0;
  margin: 4px 0;
}

/* Responsive Design */
@media (max-width: 768px) {
  .main-content {
    margin-left: 0;
    padding: 20px;
  }
  
  .sidebar {
    transform: translateX(-100%);
  }
  
  .sidebar:hover {
    transform: translateX(0);
  }
  
}
    .logs-container { background: white; padding: 30px; border-radius: 15px; width: 100%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); margin: 0 auto; }
    .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .logs-header h2 { color: #021D44; font-size: 1.1rem; font-weight: 700; }
    .submit-new-btn { padding: 10px 18px; background-color: #021D44; color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-decoration: none; }
    .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 0.9rem; color: #555; }
    .table-controls .search-bar { display: flex; align-items: center; gap: 8px; }
    .table-controls input[type="search"] { padding: 5px 8px; border: 1px solid #E0E0E0; border-radius: 5px; }
    .table-controls select { padding: 5px; border: 1px solid #E0E0E0; border-radius: 5px; }
    .issues-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .issues-table th, .issues-table td { padding: 12px 15px; text-align: left; font-size: 0.85rem; word-wrap: break-word; }
    .issues-table thead { background-color: #021D44; color: white; }
    .issues-table th { font-weight: 600; }
    .issues-table tbody tr { border-bottom: 1px solid #E0E0E0; }
    .issues-table tbody td { color: #333; }
    .no-data td { text-align: center; padding: 40px; color: #9197B3; }
    .table-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 0.9rem; color: #555; }
    .pagination a { color: #555; padding: 8px 12px; text-decoration: none; border: 1px solid #E0E0E0; margin: 0 2px; border-radius: 5px; }
    .pagination a:hover { background-color: #f0f0f0; }
    .action-btn { padding: 5px 10px; background-color: #021D44; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .action-btn:hover { background-color: #218838; }
    .action-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
     .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        color:#fffcfc;
        background-color: #021D44;
         border-radius: 15px;
        padding: 10%;
        justify-content: center;
        align-items: center;
        border-bottom: 3px solid #021D44;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    .modal-title {
        color: #021D44;
        justify-content: center;
        align-items: center ;
        font-size: 1.2rem;
        font-weight: 700;
    }
    .modal-close {
        cursor: pointer;
        font-size: 1.5rem;
        border: none;
        background: none;
        color: #555;
    }
    .modal-body .detail-group {
        margin-bottom: 15px;
    }
    .modal-body .detail-group strong {
        display: block;
        color: #021D44;
        margin-bottom: 5px;
    }
    .modal-body .detail-content {
        background-color: #f8f9ff;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        min-height: 80px;
    }
    #modal-reply-textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #E0E0E0;
        border-radius: 8px;
        margin-top: 5px;
        font-size: 0.9rem;
    }
    #modal-send-reply-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background-color: #021D44;
        border-radius: 10px;
        color: white;
        
    }
    @media (max-width: 768px) { .main-content { margin-left: 0; padding: 20px; } .sidebar { transform: translateX(-100%); } .sidebar:hover { transform: translateX(0); } }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
</head>
<body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="logo" />
        <span class="logo-text">UIP <br>Tracker</span>
      </div>

      <ul class="sidebar-links">
        <li><a href="#"><span class="material-symbols-outlined">dashboard</span>Dashboard<span class="chevron">&gt;</span></a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Attendance<span class="chevron">&gt;</span></a></li>
        <li><a href="#"><span class="material-symbols-outlined">account_circle</span>Online Users<span class="chevron">&gt;</span></a></li>
        <li><a href="#"><span class="material-symbols-outlined">notifications_active</span>Event<span class="chevron">&gt;</span></a></li>
        <li><a href="#"><span class="material-symbols-outlined">flag</span>Help<span class="chevron">&gt;</span></a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Developers<span class="chevron">&gt;</span></a></li>
      </ul>
    </aside>

<main class="main-content">
      <!-- Header -->
      <div class="header">
        <h1>REPORT MANAGEMENT</h1>
        <button class="user-profile" onclick="toggleDropdown()">
          <div class="user-avatar">AD</div>
          <div class="user-details">
            <h3>Administrator User</h3>
            <p>Administrator</p>
          </div>
          <span class="material-symbols-outlined" style="color: #9197B3;">expand_more</span>
          
          <div class="dropdown-menu" id="userDropdown">
            <a href="#" class="dropdown-item">
              <span class="material-symbols-outlined">person</span>
              Profile
            </a>
            <a href="#" class="dropdown-item">
              <span class="material-symbols-outlined">settings</span>
              Change Password
            </a>
          <div class="dropdown-divider" style="margin: 0 16px;"></div>
            <a href="#" class="dropdown-item">
              <span class="material-symbols-outlined">logout</span>
              Sign out
            </a>
          </div>
        </button>
      </div>

   <div class="logs-container">
                <div class="logs-header">
                    <h2>SUBMITTED ISSUES</h2>
                </div>
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Application ID</th>
                            <th>Name</th>
                            <th>Ticket ID</th>
                            <th>Subject</th>
                            <th>Details</th>
                            <th>Files</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="issuesTableBody">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

     <!-- MODAL HTML STRUCTURE (Redesigned) -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>View Report</h2>
        </div>
        <div class="modal-body">
            <div class="detail-group" style="grid-column: 1 / 2;">
                <label>TICKET ID</label>
                <div class="detail-content" id="modal-ticket-id"></div>
            </div>
            <div class="detail-group" style="grid-column: 2 / 3;">
                <label>APPLICATION ID</label>
                <div class="detail-content" id="modal-user-id"></div>
            </div>
            <div class="detail-group">
                <label>NAME</label>
                <div class="detail-content" id="modal-user-name"></div>
            </div>
            <div class="detail-group">
                <label>SUBJECT</label>
                <div class="detail-content" id="modal-subject"></div>
            </div>
            <div class="detail-group">
                <label>DETAILS</label>
                <div class="detail-content" id="modal-details"></div>
            </div>
            <div class="detail-group">
                <label>FILES</label>
                <div class="detail-content" id="modal-files"></div>
            </div>
            <div class="detail-group">
                <label>REPLY</label>
                <textarea id="modal-reply-textarea" placeholder="Type your reply here..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-back" id="modal-send-reply-btn" onclick="closeModal()">BACK</button>
            <button class="btn btn-reply" id="modal-send-reply-btn">REPLY</button>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('reportModal');
    let currentReportId = null;

    // --- MODAL FUNCTIONS ---
    window.openModal = function(report) {
        currentReportId = report.id;
        document.getElementById('modal-ticket-id').textContent = report.ticket_id;
        document.getElementById('modal-user-id').textContent = report.user_id;
        document.getElementById('modal-user-name').textContent = report.user_name;
        document.getElementById('modal-subject').textContent = report.subject;
        document.getElementById('modal-details').innerHTML = report.details; // Use innerHTML to render formatted text
        document.getElementById('modal-files').innerHTML = report.files ? `<a href="${report.files}" target="_blank" rel="noopener noreferrer">View File</a>` : 'No file submitted.';
        document.getElementById('modal-reply-textarea').value = report.admin_reply || '';
        modal.style.display = 'flex';
    }

    window.closeModal = function() {
        modal.style.display = 'none';
        currentReportId = null;
    }

    // --- API CALLS ---
     async function sendReply() {
        if (!currentReportId) return;
        const replyText = document.getElementById('modal-reply-textarea').value;
        if (!replyText.trim()) { return alert('Reply cannot be empty.'); }
        try {
            const response = await fetch(`http://localhost:3000/api/reports/${currentReportId}/reply`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reply: replyText })
            });
            if (!response.ok) throw new Error('Failed to send reply.');
            alert('Reply sent successfully!');
            closeModal();
            loadReports();
        } catch (error) {
            console.error('Error sending reply:', error);
            alert('Error: Could not send reply.');
        }
    }

    window.updateStatus = async function(reportId) {
        if (!confirm(`Are you sure you want to mark report REP-${reportId} as "Fixed"?`)) return;
        try {
            const response = await fetch(`http://localhost:3000/api/reports/${reportId}/status`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to update status.');
            alert('Report status updated successfully!');
            loadReports();
        } catch (error) {
            console.error('Error updating status:', error);
            alert(`Error: ${error.message}`);
        }
    }

    async function loadReports() {
        const tableBody = document.getElementById('issuesTableBody');
        try {
            const response = await fetch('http://localhost:3000/api/reports');
            const result = await response.json();
            const reports = result.data;
            
            tableBody.innerHTML = '';

            if (reports && reports.length > 0) {
                reports.forEach(report => {
                    const row = document.createElement('tr');
                    // Make the report object a valid JSON string for the onclick attribute
                    const reportString = JSON.stringify(report).replace(/'/g, "&apos;");
                    
                    const viewButton = `<button class="btn btn-view" onclick='openModal(${reportString})'>View/Reply</button>`;
                    const fixedButton = `<button class="btn btn-fixed" onclick="updateStatus(${report.id})"><span class="material-symbols-outlined">check</span></button>`;
                    
                    row.innerHTML = `
                        <td>${report.user_id || 'N/A'}</td>
                        <td>${report.user_name || 'N/A'}</td>
                        <td>${report.ticket_id}</td>
                        <td>${report.subject}</td>
                        <td>${report.details.substring(0, 15)}...</td>
                        <td>${report.files ? `<a href="${report.files}" target="_blank" rel="noopener noreferrer">Link</a>` : 'None'}</td>
                        <td>${report.status}</td>
                        <td>${viewButton} ${report.status === 'Pending' ? fixedButton : ''}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">No data available in table</td></tr>`;
            }
        } catch (error) {
            console.error('Error fetching reports:', error);
            tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">Error loading data.</td></tr>`;
        }
    }
    
    // --- INITIAL LOAD & EVENT LISTENERS ---
    loadReports();
    document.getElementById('modal-send-reply-btn').addEventListener('click', sendReply);
    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            closeModal();
        }
    });
});
</script>
<script>
   document.addEventListener("DOMContentLoaded", function () {
  const profileBtn = document.getElementById("profileBtn");
  const profileMenu = document.getElementById("profileMenu");

  profileBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const isExpanded = profileBtn.getAttribute("aria-expanded") === "true";
    if (isExpanded) {
      profileMenu.classList.remove("show");
      profileBtn.setAttribute("aria-expanded", "false");
    } else {
      profileMenu.classList.add("show");
      profileBtn.setAttribute("aria-expanded", "true");
    }
  });

  document.addEventListener("click", () => {
    profileMenu.classList.remove("show");
    profileBtn.setAttribute("aria-expanded", "false");
  });
    });
          // Dropdown functionality
      function toggleDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const userProfile = document.querySelector('.user-profile');
        const dropdown = document.getElementById('userDropdown');
        
        if (!userProfile.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      });

      // Add click handlers for navigation
      document.querySelectorAll('.sidebar-links a').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all links
          document.querySelectorAll('.sidebar-links a').forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          this.classList.add('active');
        });
    });
</script>
</body>
</html>