<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UIP Attendance Tracker</title>
    <link rel="stylesheet" href="user-dashboard.css" />
    <!-- Google Material Symbols for icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />

  </head>
  <body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="logo" />
         <span class="logo-text">UIP Tracker</span>
      </div>
      <ul class="sidebar-links">
        <!-- FIX #1: Added the correct href for the dashboard -->
        <li><a href="user-dashboard.html" class="active"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Attendance</a></li>
        <li><a href="#"><span class="material-symbols-outlined">account_circle</span>Online Users</a></li>
        <li><a href="#"><span class="material-symbols-outlined">notifications_active</span>Event</a></li>
        <!-- FIX #2: Ensured the Help link is correct -->
        <li><a href="user-help.html"><span class="material-symbols-outlined">flag</span>Help</a></li>
        <li><a href="#"><span class="material-symbols-outlined">groups</span>Developers</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <!-- Header -->
      <div class="header">
         <h1 id="greetingHeader">Hello,</h1>
        <button class="user-profile" id="profileBtn" onclick="toggleDropdown()">
           <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <h3 id="userName">User Name</h3>
            <p id="userRole">Role</p>
          </div>
          <span class="material-symbols-outlined" style="color: #9197B3;">expand_more</span>
          <div class="dropdown-menu" id="userDropdown">
            <a href="#" class="dropdown-item"><span class="material-symbols-outlined">person</span>Profile</a>
            <a href="#" class="dropdown-item"><span class="material-symbols-outlined">settings</span>Change Password</a>
            <div class="dropdown-divider" style="margin: 0 16px;"></div>
            <a href="signin.html" id="logoutBtn" class="dropdown-item"><span class="material-symbols-outlined">logout</span>Sign out</a>
          </div>
        </button>
      </div>

     <!-- Dashboard Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <div class="stat-icon blue"><span class="material-symbols-outlined">link</span></div>
          <div class="stat-info"><h3 id="deductedHours">0</h3><p>Deducted Hours</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><span class="material-symbols-outlined">shopping_bag</span></div>
          <div class="stat-info"><h3 id="requiredHours">0</h3><p>Required Hours</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple"><span class="material-symbols-outlined">computer</span></div>
          <div class="stat-info"><h3 id="renderedHours">0</h3><p>Rendered Hours</p></div>
        </div>
      </div>

      <!-- Current Time and Activity Stats -->
      <div class="current-time-section">
        <div class="time-card">
          <div class="day">Monday</div>
          <div class="date">August 04, 2025</div>
          <div class="current-time" id="currentTime">02:34:27 PM</div>
          <button class="time-in-btn">TIME IN</button>
        </div>

        <div class="activity-stats">
          <div class="activity-card">
            <div class="activity-icon">
              <span class="material-symbols-outlined">event_note</span>
            </div>
            <div class="activity-info">
              <h4 id="remainingHours">0</h4>
              <p>Remaining Hours</p>
            </div>
          </div>

          <div class="activity-card">
            <div class="activity-icon">
              <span class="material-symbols-outlined">info</span>
            </div>
            <div class="activity-info">
             <h4 id="penaltyHours">0</h4>
              <p>Penalty Hours</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Announcements -->
      <div class="announcements-section">
        <h2>Announcement</h2>
        <div id="announcementsList">
          <!-- User announcements will be dynamically loaded here -->
        </div>
      </div>

      <!-- Request Off Boarding Section -->
      <div class="request-section">
        <div class="request-card">
        <h2 style="text-align: center;">Request<br>Off Boarding</h2>
        <br>
        <p class="request-text">YOUR REMAINING<br>HOURS IS NOT<br>YET OVER</p>
        </div>

        <!-- Progress Section -->
        <div class="progress-card">
            <div class="progress-stats">
            <div class="progress-stat rendered">
              <h3>216</h3>
              <p>Rendered</p>
            </div>
            
            <div class="progress-stat">
              <h3>Attendance<br>Progress</h3>
            </div>
            
            <div class="progress-stat remaining">
              <h3>84</h3>
              <p>Remaining</p>
            </div>
          </div>
        <div class="progress-circle">
            <svg class="progress-ring" width="200" height="200">
              <circle class="progress-background" cx="100" cy="100" r="80"></circle>
              <circle class="progress-bar" cx="100" cy="100" r="80"></circle>
            </svg>
            <div class="progress-text-center">72%</div>
          </div>
        </div>
      </div>

    </main>

  <!-- SINGLE, CONSOLIDATED SCRIPT FOR ALL PAGE FUNCTIONALITY -->
<script>
      document.addEventListener('DOMContentLoaded', () => {

        // --- NEW: User Personalization Logic ---
         const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) {
        alert('You are not logged in. Redirecting to login page.');
        window.location.href = '/uip-tracker/signin.html'; // Use full path for reliability
        return;
    }

    // --- 2. Personalize Page Elements ---
    document.getElementById('greetingHeader').textContent = `Hello ${loggedInUser.full_name},`;
    document.getElementById('userName').textContent = loggedInUser.full_name;
    document.getElementById('userRole').textContent = loggedInUser.role;
    const nameParts = loggedInUser.full_name.split(' ');
    const initials = (nameParts.length > 1) ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : nameParts[0][0];
    document.getElementById('userAvatar').textContent = initials.toUpperCase();
      });

     // Function to fetch user-specific stats (hours, etc.)
    async function loadUserStats() {
        try {
            // Call the PHP file and pass the user's ID as a URL parameter
            const response = await fetch(`api_get_user_stats.php?id=${loggedInUser.id}`);
            if (!response.ok) throw new Error('Failed to fetch user stats.');
            
            const result = await response.json();
            if (result.message === 'success') {
                const stats = result.data;
                document.getElementById('requiredHours').textContent = stats.total_hours || 0;
                document.getElementById('renderedHours').textContent = stats.rendered_hours || 0;
                // You can add more stats here as you add them to your database
            }
        } catch (error) {
            console.error("Could not load user stats:", error);
        }
    }
</script>

    
    <script>
      const profileBtn = document.getElementById('profileBtn');
        const userDropdown = document.getElementById('userDropdown');
        if (profileBtn && userDropdown) {
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('show');
            });
        }
        document.addEventListener('click', (event) => {
            if (userDropdown && profileBtn && !profileBtn.contains(event.target)) {
                userDropdown.classList.remove('show');
            }
        });
        
        // --- Logic for Logout Button ---
        const logoutBtn = document.getElementById('logoutBtn');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Clear user data from storage
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('token');
                // Redirect to login page
                window.location.href = '/uip-tracker/signin.html';
            });
        }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const userProfile = document.querySelector('.user-profile');
        const dropdown = document.getElementById('userDropdown');
        
        if (!userProfile.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      });

      // Update current time
      function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {
          hour12: true,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        document.getElementById('currentTime').textContent = timeString;
      }

      // Update time immediately and then every second
      updateTime();
      setInterval(updateTime, 1000);

    
        document.querySelectorAll('.sidebar-links a').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-links a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });

    </script>

    <script>
         async function fetchAnnouncements() {
        const announcementsList = document.getElementById('announcementsList');
        try {
            const response = await fetch('api_get_announcements.php');
            if (!response.ok) throw new Error('Failed to fetch announcements.');
            
            const announcements = await response.json();
            announcementsList.innerHTML = '';
            if (announcements.length > 0) {
                announcements.forEach(ann => {
                    const item = document.createElement('div');
                    item.className = 'announcement-item';
                    item.innerHTML = `
                        <div class="announcement-header"><div class="announcement-title">${ann.title}</div></div>
                        <div class="announcement-date">UIP STAFF | ${ann.date}</div>
                        <div class="announcement-status">Status: ${ann.status}</div>
                        <div class="announcement-greeting">${ann.greeting}</div>
                        <p class="announcement-content">${ann.content.replace(/\n/g, '<br>')}</p>
                    `;
                    announcementsList.appendChild(item);
                });
            } else {
                announcementsList.innerHTML = '<p>No announcements at the moment.</p>';
            }
        } catch (error) {
            console.error("Error fetching announcements:", error);
        }
    }

     // --- 5. Initial Data Load ---
    loadUserStats();
    fetchAnnouncements();
    </script>
  </body>
</html>